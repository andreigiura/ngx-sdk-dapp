import { __decorate } from "tslib";
import { Inject, Injectable } from '@angular/core';
import { Select } from '@ngxs/store';
import { lastValueFrom, map, skipWhile, take } from 'rxjs';
import { DAPP_CONFIG } from '../../config';
import { AddTransactionsBatch, CancelPendingSignature, ChangeTxStatus, RemoveTransaction, ResetTransactions, SetTransactionHashes, } from '../../ngxs/account/transactions.actions';
import { TxStatusEnum } from '../../types';
import * as i0 from "@angular/core";
import * as i1 from "../authProviders/PermissionsProvider";
import * as i2 from "@ngxs/store";
import * as i3 from "../../ngxs/account/account-api.service";
import * as i4 from "../account/account.service";
import * as i5 from "../../pipes/parseAmount/parse-amount.pipe";
export class TransactionsService {
    constructor(permissionsProvider, store, accountApi, accountService, parseAmount, config) {
        this.permissionsProvider = permissionsProvider;
        this.store = store;
        this.accountApi = accountApi;
        this.accountService = accountService;
        this.parseAmount = parseAmount;
        this.config = config;
        this.toasts = [];
        this.toastTemplate = null;
        this.trackedTransactions = [];
        setTimeout(() => {
            this.transactions$?.subscribe((state) => {
                for (const transaction of state.transactions) {
                    if (transaction.status === TxStatusEnum.SIGNED &&
                        !transaction.options.signOnly) {
                        this.sendTxToAPI(transaction.transactions, transaction.id);
                    }
                    if (transaction.status === TxStatusEnum.SIGNATURE_FAILED ||
                        transaction.status === TxStatusEnum.CANCELLED ||
                        transaction.status === TxStatusEnum.SEND_IN_PROGRESS ||
                        transaction.status === TxStatusEnum.SENT_SUCCESS ||
                        transaction.status === TxStatusEnum.SENT_ERROR) {
                        const transactionsInfo = transaction.transactionsHashes?.map((txHash) => ({
                            txHash: txHash,
                            status: TxStatusEnum.SEND_IN_PROGRESS,
                        }));
                        this.show(transaction.options.transactionTitle, transactionsInfo || [], transaction.id, transaction.status);
                        if (transaction.transactionsHashes?.length &&
                            !this.trackedTransactions.includes(transaction.id)) {
                            this.trackedTransactions.push(transaction.id);
                            this.trackTransactionStatus(transaction);
                        }
                    }
                }
            });
        }, 1000);
        this.watchUnload();
    }
    async watchUnload() {
        window.onbeforeunload = (e) => {
            if (this.permissionsProvider.provider?.cancelAction) {
                this.permissionsProvider.provider.cancelAction();
                this.store.dispatch(new CancelPendingSignature());
            }
        };
    }
    async trackTransactionStatus(transaction) {
        if (!transaction.transactionsHashes)
            return;
        try {
            const txStatuses = await lastValueFrom(this.accountApi.trackTransactions(transaction.transactionsHashes));
            const shouldContinueTracking = this.updateToastStatus(txStatuses, transaction.id);
            if (shouldContinueTracking) {
                setTimeout(() => {
                    this.trackTransactionStatus(transaction);
                }, 6000);
            }
        }
        catch (error) { }
    }
    watchTransactionByTitle(txTitle, watchForStatus) {
        if (this.transactions$ === undefined)
            throw new Error('transactions$ is undefined');
        return this.transactions$
            .pipe(map((state) => {
            const tx = state.transactions.filter((tx) => {
                return tx.options.transactionTitle === txTitle;
            });
            return tx[0];
        }))
            .pipe(skipWhile((tx) => !tx || tx.status !== watchForStatus))
            .pipe(take(1));
    }
    hasTransactionsInStatus(status) {
        if (this.transactions$ === undefined)
            throw new Error('transactions$ is undefined');
        return this.transactions$.pipe(map((transaction) => transaction.transactions.some((tx) => {
            return tx.status === status;
        })));
    }
    updateToastStatus(txHashesStatus, transactionId) {
        let shouldContinueTracking = false;
        this.toasts.map((toast) => {
            if (toast.id === transactionId) {
                for (let i in txHashesStatus) {
                    switch (txHashesStatus[i].status) {
                        case 'fail':
                            this.store.dispatch(new ChangeTxStatus({
                                id: transactionId,
                                newStatus: TxStatusEnum.SENT_ERROR,
                            }));
                            toast.transactionsInfo[i].status = TxStatusEnum.SENT_ERROR;
                            break;
                        case 'success':
                            this.store.dispatch(new ChangeTxStatus({
                                id: transactionId,
                                newStatus: TxStatusEnum.SENT_SUCCESS,
                            }));
                            toast.transactionsInfo[i].status = TxStatusEnum.SENT_SUCCESS;
                            break;
                        default:
                            break;
                    }
                }
                const shouldContinue = toast.transactionsInfo.some((tx) => tx.status === TxStatusEnum.SEND_IN_PROGRESS);
                const shouldSetSuccess = toast.transactionsInfo.every((tx) => tx.status === TxStatusEnum.SENT_SUCCESS);
                const shouldSetError = toast.transactionsInfo.some((tx) => tx.status === TxStatusEnum.SENT_ERROR);
                if (shouldSetError) {
                    toast.status = TxStatusEnum.SENT_ERROR;
                }
                if (shouldSetSuccess) {
                    toast.status = TxStatusEnum.SENT_SUCCESS;
                }
                shouldContinueTracking = shouldContinue;
            }
            return false;
        });
        if (!shouldContinueTracking) {
            this.accountService.refetchAccountData();
        }
        return shouldContinueTracking;
    }
    async sendTxToAPI(transactions, transactionsId) {
        this.store.dispatch(new ChangeTxStatus({
            newStatus: TxStatusEnum.READY_TO_SEND,
            id: transactionsId,
        }));
        try {
            const { data: { txsHashes, numOfSentTxs }, error, } = await lastValueFrom(this.accountApi.sendTransactions(transactions));
            const hashesArray = Object.values(txsHashes);
            if (error ||
                !txsHashes ||
                numOfSentTxs === 0 ||
                hashesArray.length === 0) {
                this.store.dispatch(new ChangeTxStatus({
                    newStatus: TxStatusEnum.SENT_ERROR,
                    id: transactionsId,
                }));
                return;
            }
            this.store.dispatch(new SetTransactionHashes({
                id: transactionsId,
                hashes: hashesArray,
            }));
            this.store.dispatch(new ChangeTxStatus({
                newStatus: TxStatusEnum.SEND_IN_PROGRESS,
                id: transactionsId,
            }));
        }
        catch (error) {
            this.store.dispatch(new ChangeTxStatus({
                newStatus: TxStatusEnum.SENT_ERROR,
                id: transactionsId,
            }));
        }
    }
    sendTransactions(transactions, txOptions) {
        const txId = Date.now();
        const transactionsToSend = transactions.map((tx, index) => ({
            ...tx,
            nonce: this.accountService.account.nonce + index,
            sender: this.accountService.account.address,
            data: Buffer.from(tx.data ?? '', 'utf8').toString('base64'),
            value: this.parseAmount.transform(tx.value),
            chainID: this.config.chainID,
            //TODO: change version if needed (ledger, guardians, etc)
            version: 1,
        }));
        this.store.dispatch(new AddTransactionsBatch({
            id: txId,
            transactions: transactionsToSend,
            status: TxStatusEnum.PENDING_SIGNATURE,
            options: txOptions,
        }));
        this.permissionsProvider.sendTransactions(transactionsToSend, txId);
        return txId;
    }
    show(header, transactionsInfo, txId, status) {
        if (!this.toastTemplate)
            throw new Error('TransactionsService: toastTemplate is not set');
        if (this.toasts.find((t) => t.id === txId))
            return;
        this.toasts.push({
            id: txId,
            header,
            status,
            transactionsInfo,
            templateRef: this.toastTemplate,
        });
    }
    remove(toastId) {
        this.store.dispatch(new RemoveTransaction({ id: toastId }));
        this.toasts = this.toasts.filter((t) => t.id != toastId);
    }
    setTxTemplate(template) {
        this.toastTemplate = template;
    }
    resetToInitialState() {
        this.store.dispatch(new ResetTransactions());
    }
}
TransactionsService.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "15.2.1", ngImport: i0, type: TransactionsService, deps: [{ token: i1.PermissionsProviderService }, { token: i2.Store }, { token: i3.AccountApiService }, { token: i4.AccountService }, { token: i5.ParseAmountPipe }, { token: DAPP_CONFIG }], target: i0.ɵɵFactoryTarget.Injectable });
TransactionsService.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "15.2.1", ngImport: i0, type: TransactionsService, providedIn: 'root' });
__decorate([
    Select()
], TransactionsService.prototype, "transactions$", void 0);
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "15.2.1", ngImport: i0, type: TransactionsService, decorators: [{
            type: Injectable,
            args: [{
                    providedIn: 'root',
                }]
        }], ctorParameters: function () { return [{ type: i1.PermissionsProviderService }, { type: i2.Store }, { type: i3.AccountApiService }, { type: i4.AccountService }, { type: i5.ParseAmountPipe }, { type: undefined, decorators: [{
                    type: Inject,
                    args: [DAPP_CONFIG]
                }] }]; }, propDecorators: { transactions$: [] } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidHJhbnNhY3Rpb25zLnNlcnZpY2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi9wcm9qZWN0cy9uZ3gtc2RrLWRhcHAvc3JjL2xpYi9zZXJ2aWNlcy90cmFuc2FjdGlvbnMvdHJhbnNhY3Rpb25zLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU8sRUFBRSxNQUFNLEVBQUUsVUFBVSxFQUFlLE1BQU0sZUFBZSxDQUFDO0FBRWhFLE9BQU8sRUFBRSxNQUFNLEVBQVMsTUFBTSxhQUFhLENBQUM7QUFDNUMsT0FBTyxFQUFFLGFBQWEsRUFBRSxHQUFHLEVBQWMsU0FBUyxFQUFFLElBQUksRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUN2RSxPQUFPLEVBQWMsV0FBVyxFQUFFLE1BQU0sY0FBYyxDQUFDO0FBRXZELE9BQU8sRUFDTCxvQkFBb0IsRUFDcEIsc0JBQXNCLEVBQ3RCLGNBQWMsRUFDZCxpQkFBaUIsRUFDakIsaUJBQWlCLEVBQ2pCLG9CQUFvQixHQUNyQixNQUFNLHlDQUF5QyxDQUFDO0FBTWpELE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSxhQUFhLENBQUM7Ozs7Ozs7QUErQjNDLE1BQU0sT0FBTyxtQkFBbUI7SUFROUIsWUFDVSxtQkFBK0MsRUFDL0MsS0FBWSxFQUNaLFVBQTZCLEVBQzdCLGNBQThCLEVBQzlCLFdBQTRCLEVBQ1IsTUFBa0I7UUFMdEMsd0JBQW1CLEdBQW5CLG1CQUFtQixDQUE0QjtRQUMvQyxVQUFLLEdBQUwsS0FBSyxDQUFPO1FBQ1osZUFBVSxHQUFWLFVBQVUsQ0FBbUI7UUFDN0IsbUJBQWMsR0FBZCxjQUFjLENBQWdCO1FBQzlCLGdCQUFXLEdBQVgsV0FBVyxDQUFpQjtRQUNSLFdBQU0sR0FBTixNQUFNLENBQVk7UUFiekMsV0FBTSxHQUFnQixFQUFFLENBQUM7UUFHaEMsa0JBQWEsR0FBNEIsSUFBSSxDQUFDO1FBRXRDLHdCQUFtQixHQUFhLEVBQUUsQ0FBQztR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WUFDTixnQkFBZ0I7WUFDaEIsV0FBVyxFQUFFLElBQUksQ0FBQyxhQUFhO1NBQ2hDLENBQUMsQ0FBQztJQUNMLENBQUM7SUFFRCxNQUFNLENBQUMsT0FBZTtRQUNwQixJQUFJLENBQUMsS0FBSyxDQUFDLFFBQVEsQ0FBQyxJQUFJLGlCQUFpQixDQUFDLEVBQUUsRUFBRSxFQUFFLE9BQU8sRUFBRSxDQUFDLENBQUMsQ0FBQztRQUM1RCxJQUFJLENBQUMsTUFBTSxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUMsRUFBRSxJQUFJLE9BQU8sQ0FBQyxDQUFDO0lBQzNELENBQUM7SUFFRCxhQUFhLENBQUMsUUFBYTtRQUN6QixJQUFJLENBQUMsYUFBYSxHQUFHLFFBQVEsQ0FBQztJQUNoQyxDQUFDO0lBRUQsbUJBQW1CO1FBQ2pCLElBQUksQ0FBQyxLQUFLLENBQUMsUUFBUSxDQUFDLElBQUksaUJBQWlCLEVBQUUsQ0FBQyxDQUFDO0lBQy9DLENBQUM7O2dIQXhUVSxtQkFBbUIsK0tBY3BCLFdBQVc7b0hBZFYsbUJBQW1CLGNBRmxCLE1BQU07QUFJUjtJQUFULE1BQU0sRUFBRTswREFBK0Q7MkZBRjdELG1CQUFtQjtrQkFIL0IsVUFBVTttQkFBQztvQkFDVixVQUFVLEVBQUUsTUFBTTtpQkFDbkI7OzBCQWVJLE1BQU07MkJBQUMsV0FBVzs0Q0FaWCxhQUFhIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0LCBJbmplY3RhYmxlLCBUZW1wbGF0ZVJlZiB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgSVBsYWluVHJhbnNhY3Rpb25PYmplY3QsIFRyYW5zYWN0aW9uIH0gZnJvbSAnQG11bHRpdmVyc3gvc2RrLWNvcmUvb3V0JztcbmltcG9ydCB7IFNlbGVjdCwgU3RvcmUgfSBmcm9tICdAbmd4cy9zdG9yZSc7XG5pbXBvcnQgeyBsYXN0VmFsdWVGcm9tLCBtYXAsIE9ic2VydmFibGUsIHNraXBXaGlsZSwgdGFrZSB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgRGFwcENvbmZpZywgREFQUF9DT05GSUcgfSBmcm9tICcuLi8uLi9jb25maWcnO1xuaW1wb3J0IHsgQWNjb3VudEFwaVNlcnZpY2UgfSBmcm9tICcuLi8uLi9uZ3hzL2FjY291bnQvYWNjb3VudC1hcGkuc2VydmljZSc7XG5pbXBvcnQge1xuICBBZGRUcmFuc2FjdGlvbnNCYXRjaCxcbiAgQ2FuY2VsUGVuZGluZ1NpZ25hdHVyZSxcbiAgQ2hhbmdlVHhTdGF0dXMsXG4gIFJlbW92ZVRyYW5zYWN0aW9uLFxuICBSZXNldFRyYW5zYWN0aW9ucyxcbiAgU2V0VHJhbnNhY3Rpb25IYXNoZXMsXG59IGZyb20gJy4uLy4uL25neHMvYWNjb3VudC90cmFuc2FjdGlvbnMuYWN0aW9ucyc7XG5pbXBvcnQge1xuICBTaW5nbGVUcmFuc2FjdGlvbk1vZGVsLFxuICBUcmFuc2FjdGlvbnNTdGF0ZU1vZGVsLFxufSBmcm9tICcuLi8uLi9uZ3hzL2FjY291bnQvdHJhbnNhY3Rpb25zLnNsaWNlJztcbmltcG9ydCB7IFBhcnNlQW1vdW50UGlwZSB9IGZyb20gJy4uLy4uL3BpcGVzL3BhcnNlQW1vdW50L3BhcnNlLWFtb3VudC5waXBlJztcbmltcG9ydCB7IFR4U3RhdHVzRW51bSB9IGZyb20gJy4uLy4uL3R5cGVzJztcbmltcG9ydCB7IEFjY291bnRTZXJ2aWNlIH0gZnJvbSAnLi4vYWNjb3VudC9hY2NvdW50LnNlcnZpY2UnO1xuaW1wb3J0IHsgUGVybWlzc2lvbnNQcm92aWRlclNlcnZpY2UgfSBmcm9tICcuLi9hdXRoUHJvdmlkZXJzL1Blcm1pc3Npb25zUHJvdmlkZXInO1xuXG5leHBvcnQgaW50ZXJmYWNlIFRyYW5zYWN0aW9uc09wdGlvbnMge1xuICBzaWduT25seT86IGJvb2xlYW47XG4gIHRyYW5zYWN0aW9uVGl0bGU6IHN0cmluZztcbn1cblxuZXhwb3J0IGludGVyZmFjZSBUcmFuc2FjdGlvbnNUb1NlbmQge1xuICBpZDogbnVtYmVyO1xuICB0cmFuc2FjdGlvbnM6IElQbGFpblRyYW5zYWN0aW9uT2JqZWN0W107XG4gIHR4T3B0aW9uczogVHJhbnNhY3Rpb25zT3B0aW9ucztcbn1cblxuaW50ZXJmYWNlIFR4SW5mb1R5cGUge1xuICB0eEhhc2g6IHN0cmluZztcbiAgc3RhdHVzOiBzdHJpbmc7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgVG9hc3RJbmZvIHtcbiAgaWQ6IG51bWJlcjtcbiAgaGVhZGVyOiBzdHJpbmc7XG4gIHRyYW5zYWN0aW9uc0luZm86IFR4SW5mb1R5cGVbXTtcbiAgc3RhdHVzOiBzdHJpbmc7XG4gIHRlbXBsYXRlUmVmOiBUZW1wbGF0ZVJlZjxhbnk+O1xufVxuXG5ASW5qZWN0YWJsZSh7XG4gIHByb3ZpZGVkSW46ICdyb290Jyxcbn0pXG5leHBvcnQgY2xhc3MgVHJhbnNhY3Rpb25zU2VydmljZSB7XG4gIHB1YmxpYyB0b2FzdHM6IFRvYXN0SW5mb1tdID0gW107XG4gIEBTZWxlY3QoKSB0cmFuc2FjdGlvbnMkOiBPYnNlcnZhYmxlPFRyYW5zYWN0aW9uc1N0YXRlTW9kZWw+IHwgdW5kZWZpbmVkO1xuXG4gIHRvYXN0VGVtcGxhdGU6IFRlbXBsYXRlUmVmPGFueT4gfCBudWxsID0gbnVsbDtcblxuICBwcml2YXRlIHRyYWNrZWRUcmFuc2FjdGlvbnM6IG51bWJlcltdID0gW107XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSBwZXJtaXNzaW9uc1Byb3ZpZGVyOiBQZXJtaXNzaW9uc1Byb3ZpZGVyU2VydmljZSxcbiAgICBwcml2YXRlIHN0b3JlOiBTdG9yZSxcbiAgICBwcml2YXRlIGFjY291bnRBcGk6IEFjY291bnRBcGlTZXJ2aWNlLFxuICAgIHByaXZhdGUgYWNjb3VudFNlcnZpY2U6IEFjY291bnRTZXJ2aWNlLFxuICAgIHByaXZhdGUgcGFyc2VBbW91bnQ6IFBhcnNlQW1vdW50UGlwZSxcbiAgICBASW5qZWN0KERBUFBfQ09ORklHKSBwdWJsaWMgY29uZmlnOiBEYXBwQ29uZmlnXG4gICkge1xuICAgIHNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgdGhpcy50cmFuc2FjdGlvbnMkPy5zdWJzY3JpYmUoKHN0YXRlOiBUcmFuc2FjdGlvbnNTdGF0ZU1vZGVsKSA9PiB7XG4gICAgICAgIGZvciAoY29uc3QgdHJhbnNhY3Rpb24gb2Ygc3RhdGUudHJhbnNhY3Rpb25zKSB7XG4gICAgICAgICAgaWYgKFxuICAgICAgICAgICAgdHJhbnNhY3Rpb24uc3RhdHVzID09PSBUeFN0YXR1c0VudW0uU0lHTkVEICYmXG4gICAgICAgICAgICAhdHJhbnNhY3Rpb24ub3B0aW9ucy5zaWduT25seVxuICAgICAgICAgICkge1xuICAgICAgICAgICAgdGhpcy5zZW5kVHhUb0FQSSh0cmFuc2FjdGlvbi50cmFuc2FjdGlvbnMsIHRyYW5zYWN0aW9uLmlkKTtcbiAgICAgICAgICB9XG5cbiAgICAgICAgICBpZiAoXG4gICAgICAgICAgICB0cmFuc2FjdGlvbi5zdGF0dXMgPT09IFR4U3RhdHVzRW51bS5TSUdOQVRVUkVfRkFJTEVEIHx8XG4gICAgICAgICAgICB0cmFuc2FjdGlvbi5zdGF0dXMgPT09IFR4U3RhdHVzRW51bS5DQU5DRUxMRUQgfHxcbiAgICAgICAgICAgIHRyYW5zYWN0aW9uLnN0YXR1cyA9PT0gVHhTdGF0dXNFbnVtLlNFTkRfSU5fUFJPR1JFU1MgfHxcbiAgICAgICAgICAgIHRyYW5zYWN0aW9uLnN0YXR1cyA9PT0gVHhTdGF0dXNFbnVtLlNFTlRfU1VDQ0VTUyB8fFxuICAgICAgICAgICAgdHJhbnNhY3Rpb24uc3RhdHVzID09PSBUeFN0YXR1c0VudW0uU0VOVF9FUlJPUlxuICAgICAgICAgICkge1xuICAgICAgICAgICAgY29uc3QgdHJhbnNhY3Rpb25zSW5mbzogVHhJbmZvVHlwZVtdIHwgdW5kZWZpbmVkID1cbiAgICAgICAgICAgICAgdHJhbnNhY3Rpb24udHJhbnNhY3Rpb25zSGFzaGVzPy5tYXAoXG4gICAgICAgICAgICAgICAgKHR4SGFzaCk6IFR4SW5mb1R5cGUgPT4gKHtcbiAgICAgICAgICAgICAgICAgIHR4SGFzaDogdHhIYXNoLFxuICAgICAgICAgICAgICAgICAgc3RhdHVzOiBUeFN0YXR1c0VudW0uU0VORF9JTl9QUk9HUkVTUyxcbiAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgdGhpcy5zaG93KFxuICAgICAgICAgICAgICB0cmFuc2FjdGlvbi5vcHRpb25zLnRyYW5zYWN0aW9uVGl0bGUsXG4gICAgICAgICAgICAgIHRyYW5zYWN0aW9uc0luZm8gfHwgW10sXG4gICAgICAgICAgICAgIHRyYW5zYWN0aW9uLmlkLFxuICAgICAgICAgICAgICB0cmFuc2FjdGlvbi5zdGF0dXNcbiAgICAgICAgICAgICk7XG5cbiAgICAgICAgICAgIGlmIChcbiAgICAgICAgICAgICAgdHJhbnNhY3Rpb24udHJhbnNhY3Rpb25zSGFzaGVzPy5sZW5ndGggJiZcbiAgICAgICAgICAgICAgIXRoaXMudHJhY2tlZFRyYW5zYWN0aW9ucy5pbmNsdWRlcyh0cmFuc2FjdGlvbi5pZClcbiAgICAgICAgICAgICkge1xuICAgICAgICAgICAgICB0aGlzLnRyYWNrZWRUcmFuc2FjdGlvbnMucHVzaCh0cmFuc2FjdGlvbi5pZCk7XG4gICAgICAgICAgICAgIHRoaXMudHJhY2tUcmFuc2FjdGlvblN0YXR1cyh0cmFuc2FjdGlvbik7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9KTtcbiAgICB9LCAxMDAwKTtcblxuICAgIHRoaXMud2F0Y2hVbmxvYWQoKTtcbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgd2F0Y2hVbmxvYWQoKSB7XG4gICAgd2luZG93Lm9uYmVmb3JldW5sb2FkID0gKGUpID0+IHtcbiAgICAgIGlmICh0aGlzLnBlcm1pc3Npb25zUHJvdmlkZXIucHJvdmlkZXI/LmNhbmNlbEFjdGlvbikge1xuICAgICAgICB0aGlzLnBlcm1pc3Npb25zUHJvdmlkZXIucHJvdmlkZXIuY2FuY2VsQWN0aW9uKCk7XG4gICAgICAgIHRoaXMuc3RvcmUuZGlzcGF0Y2gobmV3IENhbmNlbFBlbmRpbmdTaWduYXR1cmUoKSk7XG4gICAgICB9XG4gICAgfTtcbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgdHJhY2tUcmFuc2FjdGlvblN0YXR1cyh0cmFuc2FjdGlvbjogU2luZ2xlVHJhbnNhY3Rpb25Nb2RlbCkge1xuICAgIGlmICghdHJhbnNhY3Rpb24udHJhbnNhY3Rpb25zSGFzaGVzKSByZXR1cm47XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHR4U3RhdHVzZXMgPSBhd2FpdCBsYXN0VmFsdWVGcm9tPGFueT4oXG4gICAgICAgIHRoaXMuYWNjb3VudEFwaS50cmFja1RyYW5zYWN0aW9ucyh0cmFuc2FjdGlvbi50cmFuc2FjdGlvbnNIYXNoZXMpXG4gICAgICApO1xuICAgICAgY29uc3Qgc2hvdWxkQ29udGludWVUcmFja2luZyA9IHRoaXMudXBkYXRlVG9hc3RTdGF0dXMoXG4gICAgICAgIHR4U3RhdHVzZXMsXG4gICAgICAgIHRyYW5zYWN0aW9uLmlkXG4gICAgICApO1xuICAgICAgaWYgKHNob3VsZENvbnRpbnVlVHJhY2tpbmcpIHtcbiAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICAgICAgdGhpcy50cmFja1RyYW5zYWN0aW9uU3RhdHVzKHRyYW5zYWN0aW9uKTtcbiAgICAgICAgfSwgNjAwMCk7XG4gICAgICB9XG4gICAgfSBjYXRjaCAoZXJyb3IpIHt9XG4gIH1cblxuICBwdWJsaWMgd2F0Y2hUcmFuc2FjdGlvbkJ5VGl0bGUoXG4gICAgdHhUaXRsZTogc3RyaW5nLFxuICAgIHdhdGNoRm9yU3RhdHVzOiBUeFN0YXR1c0VudW1cbiAgKTogT2JzZXJ2YWJsZTxTaW5nbGVUcmFuc2FjdGlvbk1vZGVsIHwgdW5kZWZpbmVkPiB7XG4gICAgaWYgKHRoaXMudHJhbnNhY3Rpb25zJCA9PT0gdW5kZWZpbmVkKVxuICAgICAgdGhyb3cgbmV3IEVycm9yKCd0cmFuc2FjdGlvbnMkIGlzIHVuZGVmaW5lZCcpO1xuXG4gICAgcmV0dXJuIHRoaXMudHJhbnNhY3Rpb25zJFxuICAgICAgLnBpcGUoXG4gICAgICAgIG1hcCgoc3RhdGUpID0+IHtcbiAgICAgICAgICBjb25zdCB0eCA9IHN0YXRlLnRyYW5zYWN0aW9ucy5maWx0ZXIoKHR4KSA9PiB7XG4gICAgICAgICAgICByZXR1cm4gdHgub3B0aW9ucy50cmFuc2FjdGlvblRpdGxlID09PSB0eFRpdGxlO1xuICAgICAgICAgIH0pO1xuICAgICAgICAgIHJldHVybiB0eFswXTtcbiAgICAgICAgfSlcbiAgICAgIClcbiAgICAgIC5waXBlKHNraXBXaGlsZSgodHgpID0+ICF0eCB8fCB0eC5zdGF0dXMgIT09IHdhdGNoRm9yU3RhdHVzKSlcbiAgICAgIC5waXBlKHRha2UoMSkpO1xuICB9XG5cbiAgcHVibGljIGhhc1RyYW5zYWN0aW9uc0luU3RhdHVzKHN0YXR1czogVHhTdGF0dXNFbnVtKTogT2JzZXJ2YWJsZTxib29sZWFuPiB7XG4gICAgaWYgKHRoaXMudHJhbnNhY3Rpb25zJCA9PT0gdW5kZWZpbmVkKVxuICAgICAgdGhyb3cgbmV3IEVycm9yKCd0cmFuc2FjdGlvbnMkIGlzIHVuZGVmaW5lZCcpO1xuXG4gICAgcmV0dXJuIHRoaXMudHJhbnNhY3Rpb25zJC5waXBlKFxuICAgICAgbWFwKCh0cmFuc2FjdGlvbikgPT5cbiAgICAgICAgdHJhbnNhY3Rpb24udHJhbnNhY3Rpb25zLnNvbWUoKHR4KSA9PiB7XG4gICAgICAgICAgcmV0dXJuIHR4LnN0YXR1cyA9PT0gc3RhdHVzO1xuICAgICAgICB9KVxuICAgICAgKVxuICAgICk7XG4gIH1cblxuICBwcml2YXRlIHVwZGF0ZVRvYXN0U3RhdHVzKFxuICAgIHR4SGFzaGVzU3RhdHVzOiBBcnJheTx7IHN0YXR1czogc3RyaW5nIH0+LFxuICAgIHRyYW5zYWN0aW9uSWQ6IG51bWJlclxuICApOiBib29sZWFuIHtcbiAgICBsZXQgc2hvdWxkQ29udGludWVUcmFja2luZyA9IGZhbHNlO1xuXG4gICAgdGhpcy50b2FzdHMubWFwKCh0b2FzdCkgPT4ge1xuICAgICAgaWYgKHRvYXN0LmlkID09PSB0cmFuc2FjdGlvbklkKSB7XG4gICAgICAgIGZvciAobGV0IGkgaW4gdHhIYXNoZXNTdGF0dXMpIHtcbiAgICAgICAgICBzd2l0Y2ggKHR4SGFzaGVzU3RhdHVzW2ldLnN0YXR1cykge1xuICAgICAgICAgICAgY2FzZSAnZmFpbCc6XG4gICAgICAgICAgICAgIHRoaXMuc3RvcmUuZGlzcGF0Y2goXG4gICAgICAgICAgICAgICAgbmV3IENoYW5nZVR4U3RhdHVzKHtcbiAgICAgICAgICAgICAgICAgIGlkOiB0cmFuc2FjdGlvbklkLFxuICAgICAgICAgICAgICAgICAgbmV3U3RhdHVzOiBUeFN0YXR1c0VudW0uU0VOVF9FUlJPUixcbiAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgICB0b2FzdC50cmFuc2FjdGlvbnNJbmZvW2ldLnN0YXR1cyA9IFR4U3RhdHVzRW51bS5TRU5UX0VSUk9SO1xuICAgICAgICAgICAgICBicmVhaztcblxuICAgICAgICAgICAgY2FzZSAnc3VjY2Vzcyc6XG4gICAgICAgICAgICAgIHRoaXMuc3RvcmUuZGlzcGF0Y2goXG4gICAgICAgICAgICAgICAgbmV3IENoYW5nZVR4U3RhdHVzKHtcbiAgICAgICAgICAgICAgICAgIGlkOiB0cmFuc2FjdGlvbklkLFxuICAgICAgICAgICAgICAgICAgbmV3U3RhdHVzOiBUeFN0YXR1c0VudW0uU0VOVF9TVUNDRVNTLFxuICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgICk7XG4gICAgICAgICAgICAgIHRvYXN0LnRyYW5zYWN0aW9uc0luZm9baV0uc3RhdHVzID0gVHhTdGF0dXNFbnVtLlNFTlRfU1VDQ0VTUztcbiAgICAgICAgICAgICAgYnJlYWs7XG5cbiAgICAgICAgICAgIGRlZmF1bHQ6XG4gICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IHNob3VsZENvbnRpbnVlID0gdG9hc3QudHJhbnNhY3Rpb25zSW5mby5zb21lKFxuICAgICAgICAgICh0eCkgPT4gdHguc3RhdHVzID09PSBUeFN0YXR1c0VudW0uU0VORF9JTl9QUk9HUkVTU1xuICAgICAgICApO1xuXG4gICAgICAgIGNvbnN0IHNob3VsZFNldFN1Y2Nlc3MgPSB0b2FzdC50cmFuc2FjdGlvbnNJbmZvLmV2ZXJ5KFxuICAgICAgICAgICh0eCkgPT4gdHguc3RhdHVzID09PSBUeFN0YXR1c0VudW0uU0VOVF9TVUNDRVNTXG4gICAgICAgICk7XG5cbiAgICAgICAgY29uc3Qgc2hvdWxkU2V0RXJyb3IgPSB0b2FzdC50cmFuc2FjdGlvbnNJbmZvLnNvbWUoXG4gICAgICAgICAgKHR4KSA9PiB0eC5zdGF0dXMgPT09IFR4U3RhdHVzRW51bS5TRU5UX0VSUk9SXG4gICAgICAgICk7XG5cbiAgICAgICAgaWYgKHNob3VsZFNldEVycm9yKSB7XG4gICAgICAgICAgdG9hc3Quc3RhdHVzID0gVHhTdGF0dXNFbnVtLlNFTlRfRVJST1I7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoc2hvdWxkU2V0U3VjY2Vzcykge1xuICAgICAgICAgIHRvYXN0LnN0YXR1cyA9IFR4U3RhdHVzRW51bS5TRU5UX1NVQ0NFU1M7XG4gICAgICAgIH1cbiAgICAgICAgc2hvdWxkQ29udGludWVUcmFja2luZyA9IHNob3VsZENvbnRpbnVlO1xuICAgICAgfVxuXG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfSk7XG5cbiAgICBpZiAoIXNob3VsZENvbnRpbnVlVHJhY2tpbmcpIHtcbiAgICAgIHRoaXMuYWNjb3VudFNlcnZpY2UucmVmZXRjaEFjY291bnREYXRhKCk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHNob3VsZENvbnRpbnVlVHJhY2tpbmc7XG4gIH1cblxuICBwcml2YXRlIGFzeW5jIHNlbmRUeFRvQVBJKFxuICAgIHRyYW5zYWN0aW9uczogSVBsYWluVHJhbnNhY3Rpb25PYmplY3RbXSxcbiAgICB0cmFuc2FjdGlvbnNJZDogbnVtYmVyXG4gICkge1xuICAgIHRoaXMuc3RvcmUuZGlzcGF0Y2goXG4gICAgICBuZXcgQ2hhbmdlVHhTdGF0dXMoe1xuICAgICAgICBuZXdTdGF0dXM6IFR4U3RhdHVzRW51bS5SRUFEWV9UT19TRU5ELFxuICAgICAgICBpZDogdHJhbnNhY3Rpb25zSWQsXG4gICAgICB9KVxuICAgICk7XG5cbiAgICB0cnkge1xuICAgICAgY29uc3Qge1xuICAgICAgICBkYXRhOiB7IHR4c0hhc2hlcywgbnVtT2ZTZW50VHhzIH0sXG4gICAgICAgIGVycm9yLFxuICAgICAgfSA9IGF3YWl0IGxhc3RWYWx1ZUZyb208YW55PihcbiAgICAgICAgdGhpcy5hY2NvdW50QXBpLnNlbmRUcmFuc2FjdGlvbnModHJhbnNhY3Rpb25zKVxuICAgICAgKTtcblxuICAgICAgY29uc3QgaGFzaGVzQXJyYXk6IHN0cmluZ1tdID0gT2JqZWN0LnZhbHVlcyh0eHNIYXNoZXMpO1xuICAgICAgaWYgKFxuICAgICAgICBlcnJvciB8fFxuICAgICAgICAhdHhzSGFzaGVzIHx8XG4gICAgICAgIG51bU9mU2VudFR4cyA9PT0gMCB8fFxuICAgICAgICBoYXNoZXNBcnJheS5sZW5ndGggPT09IDBcbiAgICAgICkge1xuICAgICAgICB0aGlzLnN0b3JlLmRpc3BhdGNoKFxuICAgICAgICAgIG5ldyBDaGFuZ2VUeFN0YXR1cyh7XG4gICAgICAgICAgICBuZXdTdGF0dXM6IFR4U3RhdHVzRW51bS5TRU5UX0VSUk9SLFxuICAgICAgICAgICAgaWQ6IHRyYW5zYWN0aW9uc0lkLFxuICAgICAgICAgIH0pXG4gICAgICAgICk7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cblxuICAgICAgdGhpcy5zdG9yZS5kaXNwYXRjaChcbiAgICAgICAgbmV3IFNldFRyYW5zYWN0aW9uSGFzaGVzKHtcbiAgICAgICAgICBpZDogdHJhbnNhY3Rpb25zSWQsXG4gICAgICAgICAgaGFzaGVzOiBoYXNoZXNBcnJheSxcbiAgICAgICAgfSlcbiAgICAgICk7XG5cbiAgICAgIHRoaXMuc3RvcmUuZGlzcGF0Y2goXG4gICAgICAgIG5ldyBDaGFuZ2VUeFN0YXR1cyh7XG4gICAgICAgICAgbmV3U3RhdHVzOiBUeFN0YXR1c0VudW0uU0VORF9JTl9QUk9HUkVTUyxcbiAgICAgICAgICBpZDogdHJhbnNhY3Rpb25zSWQsXG4gICAgICAgIH0pXG4gICAgICApO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICB0aGlzLnN0b3JlLmRpc3BhdGNoKFxuICAgICAgICBuZXcgQ2hhbmdlVHhTdGF0dXMoe1xuICAgICAgICAgIG5ld1N0YXR1czogVHhTdGF0dXNFbnVtLlNFTlRfRVJST1IsXG4gICAgICAgICAgaWQ6IHRyYW5zYWN0aW9uc0lkLFxuICAgICAgICB9KVxuICAgICAgKTtcbiAgICB9XG4gIH1cblxuICBwdWJsaWMgc2VuZFRyYW5zYWN0aW9ucyhcbiAgICB0cmFuc2FjdGlvbnM6IE9taXQ8XG4gICAgICBJUGxhaW5UcmFuc2FjdGlvbk9iamVjdCxcbiAgICAgICdub25jZScgfCAnc2VuZGVyJyB8ICdjaGFpbklEJyB8ICd2ZXJzaW9uJ1xuICAgID5bXSxcbiAgICB0eE9wdGlvbnM6IFRyYW5zYWN0aW9uc09wdGlvbnNcbiAgKTogbnVtYmVyIHtcbiAgICBjb25zdCB0eElkID0gRGF0ZS5ub3coKTtcblxuICAgIGNvbnN0IHRyYW5zYWN0aW9uc1RvU2VuZCA9IHRyYW5zYWN0aW9ucy5tYXAoKHR4LCBpbmRleCkgPT4gKHtcbiAgICAgIC4uLnR4LFxuICAgICAgbm9uY2U6IHRoaXMuYWNjb3VudFNlcnZpY2UuYWNjb3VudC5ub25jZSArIGluZGV4LFxuICAgICAgc2VuZGVyOiB0aGlzLmFjY291bnRTZXJ2aWNlLmFjY291bnQuYWRkcmVzcyxcbiAgICAgIGRhdGE6IEJ1ZmZlci5mcm9tKHR4LmRhdGEgPz8gJycsICd1dGY4JykudG9TdHJpbmcoJ2Jhc2U2NCcpLFxuICAgICAgdmFsdWU6IHRoaXMucGFyc2VBbW91bnQudHJhbnNmb3JtKHR4LnZhbHVlKSxcbiAgICAgIGNoYWluSUQ6IHRoaXMuY29uZmlnLmNoYWluSUQsXG4gICAgICAvL1RPRE86IGNoYW5nZSB2ZXJzaW9uIGlmIG5lZWRlZCAobGVkZ2VyLCBndWFyZGlhbnMsIGV0YylcbiAgICAgIHZlcnNpb246IDEsXG4gICAgfSkpO1xuXG4gICAgdGhpcy5zdG9yZS5kaXNwYXRjaChcbiAgICAgIG5ldyBBZGRUcmFuc2FjdGlvbnNCYXRjaCh7XG4gICAgICAgIGlkOiB0eElkLFxuICAgICAgICB0cmFuc2FjdGlvbnM6IHRyYW5zYWN0aW9uc1RvU2VuZCxcbiAgICAgICAgc3RhdHVzOiBUeFN0YXR1c0VudW0uUEVORElOR19TSUdOQVRVUkUsXG4gICAgICAgIG9wdGlvbnM6IHR4T3B0aW9ucyxcbiAgICAgIH0pXG4gICAgKTtcblxuICAgIHRoaXMucGVybWlzc2lvbnNQcm92aWRlci5zZW5kVHJhbnNhY3Rpb25zKHRyYW5zYWN0aW9uc1RvU2VuZCwgdHhJZCk7XG5cbiAgICByZXR1cm4gdHhJZDtcbiAgfVxuXG4gIHNob3coXG4gICAgaGVhZGVyOiBzdHJpbmcsXG4gICAgdHJhbnNhY3Rpb25zSW5mbzogVHhJbmZvVHlwZVtdLFxuICAgIHR4SWQ6IG51bWJlcixcbiAgICBzdGF0dXM6IFR4U3RhdHVzRW51bVxuICApIHtcbiAgICBpZiAoIXRoaXMudG9hc3RUZW1wbGF0ZSlcbiAgICAgIHRocm93IG5ldyBFcnJvcignVHJhbnNhY3Rpb25zU2VydmljZTogdG9hc3RUZW1wbGF0ZSBpcyBub3Qgc2V0Jyk7XG5cbiAgICBpZiAodGhpcy50b2FzdHMuZmluZCgodCkgPT4gdC5pZCA9PT0gdHhJZCkpIHJldHVybjtcblxuICAgIHRoaXMudG9hc3RzLnB1c2goe1xuICAgICAgaWQ6IHR4SWQsXG4gICAgICBoZWFkZXIsXG4gICAgICBzdGF0dXMsXG4gICAgICB0cmFuc2FjdGlvbnNJbmZvLFxuICAgICAgdGVtcGxhdGVSZWY6IHRoaXMudG9hc3RUZW1wbGF0ZSxcbiAgICB9KTtcbiAgfVxuXG4gIHJlbW92ZSh0b2FzdElkOiBudW1iZXIpIHtcbiAgICB0aGlzLnN0b3JlLmRpc3BhdGNoKG5ldyBSZW1vdmVUcmFuc2FjdGlvbih7IGlkOiB0b2FzdElkIH0pKTtcbiAgICB0aGlzLnRvYXN0cyA9IHRoaXMudG9hc3RzLmZpbHRlcigodCkgPT4gdC5pZCAhPSB0b2FzdElkKTtcbiAgfVxuXG4gIHNldFR4VGVtcGxhdGUodGVtcGxhdGU6IGFueSkge1xuICAgIHRoaXMudG9hc3RUZW1wbGF0ZSA9IHRlbXBsYXRlO1xuICB9XG5cbiAgcmVzZXRUb0luaXRpYWxTdGF0ZSgpIHtcbiAgICB0aGlzLnN0b3JlLmRpc3BhdGNoKG5ldyBSZXNldFRyYW5zYWN0aW9ucygpKTtcbiAgfVxufVxuIl19